services:
  # One-time permissions fix for persisted Claude Code auth volume.
  # Named volumes are root-owned by default on first create; this makes them writable
  # by the `nextjs` user (uid/gid 1001) before the app starts.
  workflow-init-perms:
    image: alpine:3.20
    container_name: workflow-init-perms
    user: '0:0'
    entrypoint: ['sh', '-lc']
    command:
      [
        'mkdir -p /home/nextjs/.claude /app/workspaces /secrets && chown -R 1001:1001 /home/nextjs/.claude /app/workspaces /secrets',
      ]
    volumes:
      - workflow_claude_config:/home/nextjs/.claude
      - workflow_workspaces:/app/workspaces
      - next_auth_secret:/secrets
    restart: 'no'

  workflow-app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: workflow-app
    depends_on:
      workflow-init-perms:
        condition: service_completed_successfully
    # Production note:
    # - If you're deploying behind a reverse proxy (Traefik/Caddy/nginx), do NOT publish 3000 to the host.
    #   Let the reverse proxy publish 80/443 and route internally to this container on port 3000.
    # - If you want to run the app directly (no reverse proxy), uncomment the ports section.
    # ports:
    #   - '3000:3000'
    expose:
      - '3000'
    environment:
      - NODE_ENV=production
      - NEXTAUTH_SECRET=NpFJbJe9X9mjBCvf2HhFfYnVdfa/AGf3iredF376t8M=
      - NEXTAUTH_URL=http://localhost:3000
      - GITLAB_URL=http://localhost:10080
      - INITIAL_SIGNUP_TOKEN=5b069c38b4ed2f2a2a9ab58a00291809b819f03743fd636b60c40cbe5a6840d6
      - API_RATE_LIMIT=100
      - ALLOWED_IPS=*
    volumes:
      - workflow_workspaces:/app/workspaces
      - next_auth_secret:/secrets
      # Persist Claude Code CLI auth + settings (~/.claude) across restarts/rebuilds
      - workflow_claude_config:/home/nextjs/.claude
    restart: unless-stopped
    healthcheck:
      test:
        [
          'CMD',
          'wget',
          '--no-verbose',
          '--tries=1',
          '--spider',
          'http://localhost:3000/api/health',
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    entrypoint: ['/entrypoint.sh']
    command: ['node', 'server.js']
    develop:
      watch:
        - path: ./src
          action: rebuild
        - path: ./package.json
          action: rebuild
        - path: ./pnpm-lock.yaml
          action: rebuild
        - path: ./Dockerfile
          action: rebuild
        - path: ./next.config.ts
          action: rebuild
        - path: ./public
          action: sync
          target: /app/public

  # Development service (hot reload). Run explicitly:
  #   docker compose up workflow-dev --build
  workflow-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: workflow-dev
    ports:
      - '3000:3000'
    environment:
      - NODE_ENV=development
      - NEXTAUTH_SECRET=NpFJbJe9X9mjBCvf2HhFfYnVdfa/AGf3iredF376t8M=
      - NEXTAUTH_URL=http://localhost:3000
      - GITLAB_URL=http://localhost:10080
      - INITIAL_SIGNUP_TOKEN=5b069c38b4ed2f2a2a9ab58a00291809b819f03743fd636b60c40cbe5a6840d6
      - API_RATE_LIMIT=100
      - ALLOWED_IPS=*
    volumes:
      - ./:/app
      - workflow_node_modules:/app/node_modules
      - workflow_next_cache:/app/.next
      - workflow_workspaces:/app/workspaces
      - next_auth_secret:/secrets
      # Persist Claude Code CLI auth + settings (~/.claude) across restarts/rebuilds
      - workflow_claude_config:/home/nextjs/.claude
    restart: unless-stopped

volumes:
  workflow_workspaces:
    name: workflow_workspaces
    driver: local
  next_auth_secret:
    name: workflow_next_auth_secret
  workflow_node_modules:
  workflow_next_cache:
  workflow_claude_config:
    name: workflow_claude_config

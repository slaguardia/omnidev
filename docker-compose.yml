services:
  workflow-app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: workflow-app
    ports:
      - '3000:3000'
    environment:
      - NODE_ENV=production
      - NEXTAUTH_SECRET_FILE=/secrets/nextauth.secret
      - NEXTAUTH_URL=${NEXTAUTH_URL}
    volumes:
      - workflow_workspaces:/app/workspaces
      - next_auth_secret:/secrets
    restart: unless-stopped
    healthcheck:
      test:
        [
          'CMD',
          'wget',
          '--no-verbose',
          '--tries=1',
          '--spider',
          'http://localhost:3000/api/config/validate',
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    entrypoint: ['/entrypoint.sh']
    command: ['node', 'server.js']
    develop:
      watch:
        - path: ./src
          action: rebuild
        - path: ./package.json
          action: rebuild
        - path: ./pnpm-lock.yaml
          action: rebuild
        - path: ./Dockerfile
          action: rebuild
        - path: ./next.config.ts
          action: rebuild
        - path: ./public
          action: sync
          target: /app/public

volumes:
  workflow_workspaces:
    driver: local
  next_auth_secret:
